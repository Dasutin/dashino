## Copilot instructions for this repo

- **Purpose**: Successor to smashing dashboards. Express SSE backend feeds Vite/React client that renders dashboards defined in JSON and widgets served as HTML/CSS with optional controllers.
- **Run/Build**: `npm run dev` starts API on 4040 and Vite on 4173 with proxy. `npm run dev:server` / `npm run dev:client` split processes. `npm run build` builds server+client into `dist`; `npm start` serves built assets and SSE from `dist`.
- **Dev task**: Prefer VS Code task "npm: dev" to launch server+client; stop by terminating the same task (VS Code command palette: "Tasks: Terminate Task" â†’ select "npm: dev").
- **Env**: Server/jobs load `.env` via `dotenv/config` (avoid committing secrets); server port from `PORT` (defaults 4040). Client uses `VITE_*` (e.g., `VITE_API_ORIGIN` in `web/.env.local`) for build-time config when not same-origin.
- **Server**: [src/server.ts](src/server.ts) serves `/events` SSE (ready + heartbeat tick every 5s), `/api/events` broadcast endpoint, `/api/dashboards` loader for JSON in `dashboards/`. Last message per `widgetId`/`type` is cached and replayed to new subscribers. Static serving for built web, widgets, themes, assets.
- **Jobs**: [src/server.ts](src/server.ts) auto-loads `jobs/*.js|mjs|cjs` default export `{ interval, widgetId?, type?, run(emit) }`, runs once immediately then on interval. Use `emit({ widgetId?, type?, data, at? })` and server will fill missing `widgetId`/`type`/`at`. See [jobs/ev.js](jobs/ev.js) and [jobs/forecast.js](jobs/forecast.js). Replace the Home Assistant token placeholders before use; do not commit real tokens.
- **Dashboards**: JSON schema in [dashboards/](dashboards) with `slug`, `name`, optional `theme` and `className`, `columns`, `gutter`, and `widgets: [{ id, type, title?, position { w,h,x,y } }]`. Route path reflects `slug` (landing page when none selected).
- **Client flow**: [web/src/App.tsx](web/src/App.tsx) fetches dashboards, syncs `slug` with history, and offers an Event Testing panel that POSTs to `/api/events`. Appearance toggle stored in `localStorage`.
- **Dashboard rendering**: [web/src/DashboardView.tsx](web/src/DashboardView.tsx) opens `EventSource` to `/events`, stores payloads keyed by `widgetId`, and renders a CSS grid with `columns`/`gutter`. Widget HTML/CSS is fetched from `/widgets/<type>/widget.html|css` and injected into the page; dashboard themes from `/themes/<theme>.css` are injected once per key and `className` is applied to `body`.
- **Widget controllers**: Controller modules discovered via `import.meta.glob` at `widgets/*/widget.{ts,tsx,js}`. Accepted exports: `createController`, default factory, or `create<Type>Controller`. Factories receive `{ root, widget, template }` and return optional `update(payload)`/`destroy()`; payload is the SSE JSON. Examples: [widgets/clock/widget.ts](widgets/clock/widget.ts) (self-updating clock) and [widgets/ev/widget.ts](widgets/ev/widget.ts) (stateful SVG meter).
- **Templating**: Widget HTML supports `{{ key }}` replacements using shallow dot-paths from payload data plus injected `type`, `at`, `title`, `id`. Controllers can further manipulate DOM via `update`.
- **Styling**: Widget CSS is scoped only by selector; avoid global clashes. Special cases: `nest` and `ev` get transparent wrappers to preserve their gradients (see DashboardView conditional styles). Themes now live at top-level [themes/](themes) and are served from `/themes`.
- **Data expectations**: SSE payloads are untyped; controllers should defensively cast and handle missing fields. `widgetId` should be present for routing to the right card; otherwise messages are ignored client-side.
- **Adding a widget**: Create `widgets/<type>/widget.html|css` plus optional controller. Add a dashboard entry referencing `type` and `id`. Optionally create a job that emits payloads to that `widgetId`.
- **Testing/dev tips**: Use the landing page Event Testing form or `curl /api/events` to push payloads. New SSE clients immediately receive cached last message per widget/type.
- **Known gotchas**: Home Assistant tokens in jobs are placeholders; replace locally and keep out of git. `jobs/clock.js` is a stub (emits nothing). When changing dashboard slugs, ensure history/state stays in sync and remove stale body classes.
